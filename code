<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banglar Shahzada ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶ó‡¶æ‡¶∞‡ßç‡¶° v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <!-- Application Structure Plan: Multi-screen sequential workflow.
        1. Screen 1 (Landing/Selection).
        2. Screen 2 (Input). Optional "AI Summary".
        3. Screen 3 (Results). PDF generation. Custom modal. Typing effect. NEW: AI Threat Intel for URLs, AI Email Deconstruction.
    -->
    <!-- Visualization & Content Choices:
        - PDF Report (Screen 3): Includes new AI feature outputs.
        - URL Analysis: Placeholder for screenshot preview.
        - File Analysis: Placeholder for file type icon.
    -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto+Mono:wght@300;400;500&family=Noto+Sans+Bengali:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-dark-primary: #0a0a0a;
            --bg-dark-secondary: #1a1a1a;
            --bg-dark-tertiary: #2a2a2a;
            --text-cyber-green: #00ff00;
            --text-cyber-green-dim: #00cc00;
            --text-gray-light: #cccccc;
            --text-gray-medium: #999999;
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --border-cyber: #008000;
            --error-red: #ff3333;
            --success-green: #33ff33;
            --warning-yellow: #ffff33;
        }

        body {
            font-family: 'Noto Sans Bengali', 'Roboto Mono', monospace;
            background-color: var(--bg-dark-primary);
            color: var(--text-gray-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            overflow-x: hidden;
        }
        .app-container {
            width: 100%;
            max-width: 950px;
            background-color: rgba(10, 10, 10, 0.85); 
            border: 1px solid var(--border-cyber);
            border-radius: 1rem; 
            padding: 2rem;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.2), 0 0 25px rgba(0, 255, 255, 0.1);
            backdrop-filter: blur(15px);
        }
        .screen { display: none; }
        .screen.active { display: flex; flex-direction: column; animation: matrixEntry 0.8s ease-out; }
        
        @keyframes matrixEntry {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); filter: blur(5px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0px); }
        }

        .app-header h1 {
            font-family: 'Orbitron', 'Noto Sans Bengali', sans-serif;
            font-size: 2.5rem; 
            color: var(--text-cyber-green);
            text-shadow: 0 0 10px var(--text-cyber-green), 0 0 20px var(--text-cyber-green);
            letter-spacing: 1px;
        }
        .app-header p { color: var(--text-gray-medium); font-size: 1rem; }

        .selection-card {
            background-color: var(--bg-dark-secondary);
            border: 1px solid var(--border-cyber);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .selection-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.3), 0 0 15px var(--accent-cyan);
            border-color: var(--text-cyber-green);
        }
        .selection-card-icon {
            font-size: 3rem; margin-bottom: 0.75rem;
            color: var(--text-cyber-green-dim);
            transition: color 0.3s, text-shadow 0.3s;
        }
        .selection-card:hover .selection-card-icon { color: var(--text-cyber-green); text-shadow: 0 0 8px var(--text-cyber-green); }
        .selection-card h3 { font-family: 'Orbitron', sans-serif; color: var(--text-gray-light); }
        .selection-card p { color: var(--text-gray-medium); font-size: 0.85rem; }

        .input-panel-title { font-family: 'Orbitron', sans-serif; color: var(--accent-cyan); text-align: center; margin-bottom: 1.5rem; font-size: 1.75rem; }
        .input-label { color: var(--text-cyber-green-dim); font-size: 1rem; margin-bottom: 0.5rem; display: block; }
        
        .input-field, .input-textarea {
            background-color: var(--bg-dark-tertiary);
            border: 1px solid var(--border-cyber);
            color: var(--text-cyber-green); 
            padding: 0.75rem;
            border-radius: 0.25rem;
            width: 100%;
            font-family: 'Noto Sans Bengali', 'Roboto Mono', monospace;
            box-shadow: inset 0 0 8px rgba(0, 255, 0, 0.1);
        }
        .input-field:focus, .input-textarea:focus {
            border-color: var(--text-cyber-green);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3), inset 0 0 10px rgba(0, 255, 0, 0.2);
            outline: none;
        }
        .input-textarea { min-height: 150px; resize: vertical; }

        .styled-file-input-cyber label {
            background-color: var(--border-cyber); 
            color: var(--text-cyber-green);
            border: 1px solid var(--text-cyber-green-dim);
            padding: 0.75rem 1.5rem;
            transition: all 0.3s;
            display: inline-block;
            border-radius: 0.25rem;
        }
        .styled-file-input-cyber label:hover {
            background-color: var(--text-cyber-green-dim);
            color: var(--bg-dark-primary);
            box-shadow: 0 0 15px var(--text-cyber-green);
        }

        .results-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { .results-grid { grid-template-columns: 260px 1fr; } }
        
        .score-card-results, .findings-card, .gemini-feature-card, .pdf-report-card, .visual-cue-card {
            background-color: var(--bg-dark-secondary);
            border: 1px solid var(--border-cyber);
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .chart-container-results { position: relative; width: 100%; max-width: 180px; height: 180px; margin: 0 auto 1rem auto; }
        .findings-card { max-height: 320px; overflow-y: auto; } 
        .gemini-output-container { max-height: 200px; overflow-y: auto; }
        
        .finding-category-title, .gemini-output-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.05rem; font-weight: 500; color: var(--accent-cyan);
            margin-top: 1rem; padding-bottom: 0.3rem; border-bottom: 1px solid var(--border-cyber);
        }
        .findings-list-item { padding: 0.3rem 0; font-size: 0.85rem; color: var(--text-gray-light); position: relative; padding-left: 1.5rem; }
        .findings-list-item::before { content: '>'; position: absolute; left: 0; color: var(--text-cyber-green); font-family: monospace; font-weight: bold; }
        .finding-score-impact { font-size: 0.75rem; color: var(--text-gray-medium); margin-left: 0.5rem; }

        .action-button, .gemini-button, .pdf-button {
            position: relative; overflow: hidden;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 0.25rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            border: 1px solid var(--text-cyber-green-dim);
            text-shadow: 0 0 5px var(--text-cyber-green);
            cursor: pointer;
        }
        .action-button:active, .gemini-button:active, .pdf-button:active {
            transform: scale(0.98);
            filter: brightness(0.9);
        }
        .action-button:hover, .gemini-button:hover, .pdf-button:hover {
            box-shadow: 0 0 20px var(--text-cyber-green);
            border-color: var(--text-cyber-green);
        }
        
        .primary-analyze-button {
            background: var(--text-cyber-green-dim);
            color: var(--bg-dark-primary);
        }
        .primary-analyze-button:hover { background: var(--text-cyber-green); }

        .gemini-button { background-color: transparent; color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .gemini-button:hover { background-color: var(--accent-cyan); color: var(--bg-dark-primary); box-shadow: 0 0 20px var(--accent-cyan); }
        .gemini-button:disabled { border-color: #444; color: #666; cursor: not-allowed; text-shadow: none; opacity: 0.5; }
        
        .pdf-button { background-color: transparent; color: var(--accent-magenta); border-color: var(--accent-magenta); margin-top: 0.5rem; font-size: 0.8rem; padding: 0.5rem 1rem;}
        .pdf-button:hover { background-color: var(--accent-magenta); color: var(--bg-dark-primary); box-shadow: 0 0 20px var(--accent-magenta); }
        .pdf-button:disabled { border-color: #444; color: #666; cursor: not-allowed; text-shadow: none; opacity: 0.5; }

        .gemini-output-content {
            background-color: var(--bg-dark-tertiary); padding: 0.75rem; border-radius: 0.25rem;
            font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;
            max-height: 180px; overflow-y: auto; border: 1px solid var(--border-cyber);
            color: var(--text-gray-light); font-family: 'Noto Sans Bengali', 'Roboto Mono', monospace;
            min-height: 50px; /* For typing effect visibility */
        }
        .copy-button {
            background-color: var(--accent-magenta); color: white; padding: 0.25rem 0.5rem; font-size: 0.7rem; border-radius: 0.2rem;
            margin-top: 0.5rem; transition: background-color 0.2s; border: none;
        }
        .copy-button:hover { background-color: #cc00cc; }

        /* Enhanced Loader Styles */
        .loader-small {
            width: 1rem; height: 1rem; border-width: 2px;
            border-style: solid;
            border-top-color: var(--text-cyber-green); border-right-color: var(--text-cyber-green);
            border-bottom-color: transparent; border-left-color: transparent;
            animation: spin 0.8s linear infinite;
            border-radius: 50%;
        }
        .main-loader {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 1rem;
        }
        .main-loader .loader-cyber {
            width: 50px; height: 50px;
            border: 3px solid transparent;
            border-top-color: var(--accent-cyan);
            border-right-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: relative;
        }
        .main-loader .loader-cyber::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 3px solid transparent;
            border-top-color: var(--text-cyber-green);
            border-left-color: var(--text-cyber-green);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }
        .main-loader .loader-text {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-cyan);
            font-size: 1.1rem;
            letter-spacing: 1px;
            animation: pulseText 1.5s infinite ease-in-out;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulseText { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; text-shadow: 0 0 5px var(--accent-cyan); } }


        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark-tertiary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--border-cyber); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-cyber-green-dim); }

        .back-button {
            background-color: var(--bg-dark-tertiary);
            color: var(--text-cyber-green-dim);
            border: 1px solid var(--border-cyber);
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            transition: all 0.3s;
        }
        .back-button:hover {
            background-color: var(--border-cyber);
            color: var(--text-cyber-green);
            box-shadow: 0 0 10px var(--border-cyber);
        }
        .input-screen-header { display: flex; justify-content: space-between; align-items: center; width: 100%;}

        /* Styles for the hidden div used for PDF generation via html2canvas */
        #pdf-render-area {
            position: absolute;
            left: -9999px; /* Move off-screen */
            width: 595pt; /* A4 width in points for html2canvas */
            padding: 30pt; /* Padding for the content within the PDF page */
            background-color: white; 
            color: black; 
            font-family: 'Noto Sans Bengali', Arial, sans-serif; /* Crucial for html2canvas to use this font */
            line-height: 1.6;
            font-size: 10pt; /* Base font size for PDF */
        }
        #pdf-render-area h1, #pdf-render-area h2, #pdf-render-area h3, #pdf-render-area h4, #pdf-render-area h5, #pdf-render-area h6 {
            color: #1a237e; /* Dark blue for headings */
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            margin-top: 12pt;
            margin-bottom: 6pt;
        }
        #pdf-render-area h1 { font-size: 18pt; font-weight: bold; text-align: center; margin-bottom: 20pt;}
        #pdf-render-area h2 { font-size: 16pt; font-weight: bold; }
        #pdf-render-area h3 { font-size: 14pt; font-weight: bold; color: #283593; } /* Slightly lighter blue */
        #pdf-render-area h4 { font-size: 12pt; font-weight: bold; color: #3949ab; }

        #pdf-render-area p, #pdf-render-area li {
            color: #212121; /* Dark gray for text */
            font-family: 'Noto Sans Bengali', Arial, sans-serif;
            margin-bottom: 8pt;
        }
         #pdf-render-area pre { /* For AI explanation/reply */
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            padding: 8pt;
            border-radius: 4pt;
            font-family: 'Noto Sans Bengali', 'Roboto Mono', monospace; /* Ensure correct font */
            font-size: 9pt;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 10pt;
        }
        #pdf-render-area ul { list-style-type: none; padding-left: 0; }
        #pdf-render-area li::before { content: "‚Ä¢ "; color: #555; margin-right: 5pt; }
        #pdf-render-area strong { font-weight: bold; color: #000; }
        #pdf-render-area .pdf-section-title { 
            font-size: 14pt; font-weight: bold; margin-top: 20pt; margin-bottom: 10pt; 
            border-bottom: 1.5px solid #757575; padding-bottom: 4pt; color: #1a237e;
        }
        #pdf-render-area .pdf-subsection-title { 
            font-size: 12pt; font-weight: bold; margin-top: 15pt; margin-bottom: 5pt; color: #283593;
        }
        #pdf-render-area .pdf-finding-item { margin-bottom: 6pt; line-height: 1.4;}
        #pdf-render-area .pdf-disclaimer { 
            font-size: 7pt; color: #757575; margin-top: 30pt; border-top: 1px solid #e0e0e0; padding-top: 10pt;
        }
        #pdf-render-area .input-summary {
            background-color: #e8f0fe; /* Light blue background for input */
            border-left: 3px solid #1e88e5; /* Blue left border */
            padding: 10pt;
            margin-bottom: 15pt;
            font-style: italic;
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.active { display: flex; opacity: 1; }
        .custom-modal-content {
            background-color: var(--bg-dark-secondary);
            color: var(--text-gray-light);
            padding: 2rem; border-radius: 0.5rem;
            border: 1px solid var(--border-cyber);
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.2);
            width: 90%; max-width: 500px;
            text-align: center;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .custom-modal-overlay.active .custom-modal-content { transform: scale(1); }
        .custom-modal-content h3 {
            font-family: 'Orbitron', sans-serif; color: var(--accent-cyan);
            font-size: 1.5rem; margin-bottom: 1rem;
        }
        .custom-modal-content p { font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.6; }
        .custom-modal-content button {
            background-color: var(--text-cyber-green-dim); color: var(--bg-dark-primary);
            border: none; padding: 0.6rem 1.2rem; border-radius: 0.25rem;
            font-weight: bold; cursor: pointer; transition: background-color 0.3s;
        }
        .custom-modal-content button:hover { background-color: var(--text-cyber-green); }
        .custom-modal-content.error h3 { color: var(--error-red); }
        .custom-modal-content.success h3 { color: var(--success-green); }
        .custom-modal-content.warning h3 { color: var(--warning-yellow); }

        /* URL Screenshot Placeholder */
        .url-screenshot-placeholder {
            border: 2px dashed var(--border-cyber);
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
            color: var(--text-gray-medium);
            animation: pulseBorder 2s infinite;
        }
        .url-screenshot-placeholder .fa-eye-slash { font-size: 2rem; margin-bottom: 0.5rem; }
        @keyframes pulseBorder { 0%, 100% { border-color: var(--border-cyber); } 50% { border-color: var(--text-cyber-green); } }

        /* File Icon Placeholder */
        .file-icon-placeholder {
            font-size: 3rem; color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

    </style>
</head>
<body>
    <div id="pdf-render-area" style="font-family: 'Noto Sans Bengali', Arial, sans-serif;"></div> 

    <div id="customModal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3 id="customModalTitle">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶™‡ßç‡¶§‡¶ø</h3>
            <p id="customModalMessage">‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá...</p>
            <button id="customModalCloseBtn">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header text-center mb-8">
            <h1>Banglar Shahzada ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶ó‡¶æ‡¶∞‡ßç‡¶°</h1>
            <p>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡ßç‡¶∞‡¶ú‡¶®‡ßç‡¶Æ‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶™‡ßç‡¶∞‡¶π‡¶∞‡ßÄ</p>
        </header>

        <section id="selectionScreen" class="screen active">
            <h2 class="text-3xl font-semibold text-center text-cyan-400 mb-10 font-['Orbitron']">‡¶ï‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</h2>
            <div class="grid md:grid-cols-3 gap-6 md:gap-8">
                <div class="selection-card p-6 md:p-8 rounded-xl text-center" data-inputtype="text">
                    <div class="selection-card-icon">‚úçÔ∏è</div>
                    <h3 class="text-xl md:text-2xl font-semibold mb-2">‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü / ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ</h3>
                    <p class="text-sm">‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ, ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡•§</p>
                </div>
                <div class="selection-card p-6 md:p-8 rounded-xl text-center" data-inputtype="url">
                    <div class="selection-card-icon">üîó</div>
                    <h3 class="text-xl md:text-2xl font-semibold mb-2">URL ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ</h3>
                    <p class="text-sm">‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶¨‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡•§</p>
                </div>
                <div class="selection-card p-6 md:p-8 rounded-xl text-center" data-inputtype="file">
                    <div class="selection-card-icon">üìÅ</div>
                    <h3 class="text-xl md:text-2xl font-semibold mb-2">‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</h3>
                    <p class="text-sm">‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø (‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶®‡¶∂‡¶® ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ)‡•§</p>
                </div>
            </div>
        </section>

        <section id="inputScreen" class="screen">
            <div class="input-screen-header w-full mb-6">
                <button id="backToSelectionBtn" class="back-button">‚ùÆ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®</button>
                <h2 id="inputTitle" class="text-2xl font-semibold text-cyan-400 font-['Orbitron']">‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡¶®</h2>
                <div style="width: 100px;"></div> 
            </div>
            
            <div id="textInputArea" class="input-type-area hidden w-full space-y-4 flex-grow flex flex-col">
                <label for="mainTextInput" class="input-label">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¨‡¶æ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ:</label>
                <textarea id="mainTextInput" class="input-textarea flex-grow" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®..."></textarea>
                <button id="aiSummaryBtn" class="w-full action-button gemini-button mt-2 text-sm hidden">
                    <span class="btn-text">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶Æ‡ßç‡¶¨‡¶æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                </button>
                <p id="aiSummaryNote" class="text-xs text-gray-500 hidden">AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§ ‡¶Æ‡ßÇ‡¶≤ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡ßá ‡¶è‡¶á ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§</p>
            </div>

            <div id="urlInputArea" class="input-type-area hidden w-full space-y-4 flex-grow flex flex-col">
                <label for="mainUrlInput" class="input-label">URL ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</label>
                <input type="url" id="mainUrlInput" class="input-field" placeholder="https://example.com">
                <div class="flex-grow"></div> 
            </div>

            <div id="fileInputArea" class="input-type-area hidden w-full space-y-4 flex-grow flex flex-col text-center">
                <label for="mainFileInput" class="input-label mb-3">‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
                <div class="styled-file-input-cyber w-full p-8 border-2 border-dashed border-gray-600 rounded-lg hover:border-text-cyber-green transition flex-grow flex flex-col justify-center items-center">
                    <input type="file" id="mainFileInput" class="hidden" accept=".txt,.eml,.exe,.js,.pdf.exe,.doc,.docx,.zip,.rar,.vbs,.bat,.cmd,.scr,.msi,.jar,.ps1,.sh,.docm,.xlsm,.pptm,.iso,.img,.7z,.hta,.lnk">
                    <label for="mainFileInput" class="cursor-pointer">‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    <p id="mainFileNameDisplay" class="text-sm text-gray-400 mt-3">‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</p>
                </div>
            </div>
            <button id="submitAnalysisBtn" class="w-full mt-6 py-3 px-6 text-white font-bold text-lg rounded-md shadow-lg primary-analyze-button action-button">
                <span>‡¶è‡¶ñ‡¶® ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶® üöÄ</span>
            </button>
        </section>

        <section id="resultsScreen" class="screen">
             <div class="input-screen-header w-full mb-6">
                <button id="backToInputBtn" class="back-button">‚ùÆ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</button>
                <h2 class="text-2xl font-bold text-cyan-400 font-['Orbitron']">‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
                <div style="width: 100px;"></div> 
            </div>
            <div id="resultsLoader" class="text-center py-10 my-auto main-loader">
                <div class="loader-cyber"></div>
                <p class="loader-text mt-4">‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶∏‡ßç‡¶§‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ö‡¶≤‡¶õ‡ßá...</p>
            </div>
            <div id="finalReportData" class="hidden results-grid w-full h-full"> 
                <div class="score-card-results flex flex-col justify-between text-center"> 
                    <div>
                        <div id="fileIconDisplayResults" class="file-icon-placeholder hidden text-center my-2">
                            <i class="fas fa-file-alt"></i> </div>
                        <div class="chart-container-results">
                            <canvas id="mainRiskScoreChart"></canvas>
                        </div>
                        <p class="text-5xl font-bold mt-3" id="mainRiskScoreValue">0%</p>
                        <p class="text-xl font-semibold mt-1" id="mainRiskLevelText">‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶</p>
                        <p class="text-4xl mt-2" id="mainRiskEmoji">‚úÖ</p>
                    </div>
                    <button id="downloadPdfBtn" class="w-full pdf-button text-sm hidden">
                        <span class="btn-text">üìú ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü PDF</span>
                        <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                    </button>
                </div>
                <div class="findings-card flex flex-col"> 
                    <h3 class="text-xl font-semibold text-sky-300 mb-3">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶ì ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂:</h3>
                    <div id="mainDetailedFindingsList" class="space-y-2 text-sm flex-grow overflow-y-auto pr-2"></div>
                    
                    <div id="geminiFeaturesContainer" class="mt-auto pt-4 border-t border-gray-700 space-y-3">
                        <button id="aiExplanationBtn" class="w-full gemini-button text-sm hidden">
                            <span class="btn-text">‚ú® AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡¶æ‡¶®</span>
                            <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                        </button>
                        <div id="aiExplanationOutput" class="gemini-output-container hidden">
                            <p class="gemini-output-title text-sm">AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ:</p>
                            <pre class="gemini-output-content"></pre>
                            <button id="downloadAiExplanationPdfBtn" class="w-full pdf-button text-xs mt-2 hidden">
                                <span class="btn-text">üìú ‡¶∂‡ßÅ‡¶ß‡ßÅ AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ PDF</span>
                                <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                            </button>
                        </div>

                        <button id="aiSafeReplyBtn" class="w-full gemini-button text-sm hidden">
                            <span class="btn-text">‚ú® ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®</span>
                            <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                        </button>
                        <div id="aiSafeReplyOutput" class="gemini-output-container hidden">
                            <p class="gemini-output-title text-sm">AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞:</p>
                            <pre class="gemini-output-content"></pre>
                            <button class="copy-button" id="copyReplyBtn">‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </div>

                        <button id="aiThreatIntelBtn" class="w-full gemini-button text-sm hidden">
                            <span class="btn-text">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá URL‡¶ü‡¶ø‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶ú‡¶æ‡¶®‡ßÅ‡¶®</span>
                            <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                        </button>
                        <div id="aiThreatIntelOutput" class="gemini-output-container hidden">
                            <p class="gemini-output-title text-sm">AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ (URL):</p>
                            <pre class="gemini-output-content"></pre>
                            <button id="downloadAiThreatIntelPdfBtn" class="w-full pdf-button text-xs mt-2 hidden">
                                <span class="btn-text">üìú ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤ PDF</span>
                                <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                            </button>
                        </div>

                        <button id="aiEmailDeconstructBtn" class="w-full gemini-button text-sm hidden">
                            <span class="btn-text">‚ú® AI ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶ü‡¶ø‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ ‡¶ï‡ßå‡¶∂‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                            <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                        </button>
                        <div id="aiEmailDeconstructOutput" class="gemini-output-container hidden">
                            <p class="gemini-output-title text-sm">AI ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£:</p>
                            <pre class="gemini-output-content"></pre>
                            <button id="downloadAiEmailDeconstructPdfBtn" class="w-full pdf-button text-xs mt-2 hidden">
                                <span class="btn-text">üìú ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ PDF</span>
                                <div class="loader-small animate-spin rounded-full border-2 hidden"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="urlScreenshotPlaceholderResults" class="hidden mt-4 visual-cue-card">
                <h4 class="text-md font-semibold text-sky-400 mb-2">URL ‡¶≠‡¶ø‡¶ú‡ßç‡¶Ø‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°):</h4>
                <div class="url-screenshot-placeholder">
                    <i class="fas fa-eye-slash"></i>
                    <span>‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
                </div>
            </div>
            <div id="mainFileContentPreviewResults" class="hidden mt-4 findings-card">
                 <h4 class="text-md font-semibold text-sky-400 mb-1">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø):</h4>
                 <pre id="mainFileContentPreviewPreResults" class="bg-gray-950 p-2 rounded-md text-xs text-sky-300 max-h-28 overflow-y-auto whitespace-pre-wrap border border-gray-700"></pre>
            </div>
        </section>
    </div>

    <footer class="text-center mt-8 py-4 w-full max-w-5xl">
        <p class="text-xs text-slate-500">¬© ‡ß®‡ß¶‡ß®‡ß™ Banglar Shahzada ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶ó‡¶æ‡¶∞‡ßç‡¶° v2‡•§ ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶®‡¶ü‡¶ø ‡¶°‡ßá‡¶Æ‡ßã ‡¶è‡¶¨‡¶Ç ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá ‡¶§‡ßà‡¶∞‡¶ø‡•§ Gemini API ‡¶á‡¶®‡ßç‡¶ü‡¶ø‡¶ó‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï‡•§</p>
    </footer>

<script>
    // --- START OF BANGLA FONT DATA FOR JSPDF (CRITICAL PLACEHOLDER) ---
    const banglaFontBase64 = "PLACEHOLDER_REPLACE_WITH_ACTUAL_BANGLA_FONT_BASE64_STRING";
    // --- END OF BANGLA FONT DATA FOR JSPDF ---

    // DOM Elements
    const selectionScreen = document.getElementById('selectionScreen');
    const inputScreen = document.getElementById('inputScreen');
    const resultsScreen = document.getElementById('resultsScreen');
    const selectionCards = document.querySelectorAll('.selection-card');
    
    const inputTitle = document.getElementById('inputTitle');
    const inputTypeAreas = {
        text: document.getElementById('textInputArea'),
        url: document.getElementById('urlInputArea'),
        file: document.getElementById('fileInputArea')
    };
    const mainTextInput = document.getElementById('mainTextInput');
    const mainUrlInput = document.getElementById('mainUrlInput');
    const mainFileInput = document.getElementById('mainFileInput');
    const mainFileNameDisplay = document.getElementById('mainFileNameDisplay');
    const submitAnalysisBtn = document.getElementById('submitAnalysisBtn');
    const backToSelectionBtn = document.getElementById('backToSelectionBtn');
    const backToInputBtn = document.getElementById('backToInputBtn');

    const aiSummaryBtn = document.getElementById('aiSummaryBtn');
    const aiSummaryNote = document.getElementById('aiSummaryNote');

    const resultsLoader = document.getElementById('resultsLoader');
    const finalReportData = document.getElementById('finalReportData');
    const mainRiskScoreValue = document.getElementById('mainRiskScoreValue');
    const mainRiskLevelText = document.getElementById('mainRiskLevelText');
    const mainRiskEmoji = document.getElementById('mainRiskEmoji');
    const mainDetailedFindingsList = document.getElementById('mainDetailedFindingsList');
    const scoreCardResultsDiv = document.querySelector('.score-card-results');
    const mainFileContentPreviewResultsDiv = document.getElementById('mainFileContentPreviewResults');
    const mainFileContentPreviewPreResults = document.getElementById('mainFileContentPreviewPreResults');
    const urlScreenshotPlaceholderResultsDiv = document.getElementById('urlScreenshotPlaceholderResults');
    const fileIconDisplayResults = document.getElementById('fileIconDisplayResults');


    const geminiFeaturesContainer = document.getElementById('geminiFeaturesContainer');
    const aiExplanationBtn = document.getElementById('aiExplanationBtn');
    const aiExplanationOutputDiv = document.getElementById('aiExplanationOutput');
    const aiExplanationOutputPre = aiExplanationOutputDiv.querySelector('pre');
    const downloadAiExplanationPdfBtn = document.getElementById('downloadAiExplanationPdfBtn');

    const aiSafeReplyBtn = document.getElementById('aiSafeReplyBtn');
    const aiSafeReplyOutputDiv = document.getElementById('aiSafeReplyOutput');
    const aiSafeReplyOutputPre = aiSafeReplyOutputDiv.querySelector('pre');
    const copyReplyBtn = document.getElementById('copyReplyBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    // New Gemini Feature DOM Elements
    const aiThreatIntelBtn = document.getElementById('aiThreatIntelBtn');
    const aiThreatIntelOutputDiv = document.getElementById('aiThreatIntelOutput');
    const aiThreatIntelOutputPre = aiThreatIntelOutputDiv.querySelector('pre');
    const downloadAiThreatIntelPdfBtn = document.getElementById('downloadAiThreatIntelPdfBtn');

    const aiEmailDeconstructBtn = document.getElementById('aiEmailDeconstructBtn');
    const aiEmailDeconstructOutputDiv = document.getElementById('aiEmailDeconstructOutput');
    const aiEmailDeconstructOutputPre = aiEmailDeconstructOutputDiv.querySelector('pre');
    const downloadAiEmailDeconstructPdfBtn = document.getElementById('downloadAiEmailDeconstructPdfBtn');


    // Custom Modal DOM Elements
    const customModal = document.getElementById('customModal');
    const customModalTitle = document.getElementById('customModalTitle');
    const customModalMessage = document.getElementById('customModalMessage');
    const customModalCloseBtn = document.getElementById('customModalCloseBtn');


    let mainRiskScoreChart = null;
    let currentInputTypeGlobal = 'text';
    let originalInputForGemini = ""; 
    let analysisReportForGemini = {}; 
    let isSummaryUsed = false;
    let userUploadedFileName = null; 

    // --- Custom Modal Functions ---
    function showModal(message, type = 'info', title = '‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶™‡ßç‡¶§‡¶ø') {
        customModalMessage.textContent = message;
        customModalTitle.textContent = title;
        
        const modalContent = customModal.querySelector('.custom-modal-content');
        modalContent.classList.remove('error', 'success', 'warning');
        if (type === 'error') modalContent.classList.add('error');
        else if (type === 'success') modalContent.classList.add('success');
        else if (type === 'warning') modalContent.classList.add('warning');
        
        customModal.classList.add('active');
    }
    customModalCloseBtn.addEventListener('click', () => customModal.classList.remove('active'));
    customModal.addEventListener('click', (event) => { 
        if (event.target === customModal) {
            customModal.classList.remove('active');
        }
    });


    function navigateToScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if (screenId !== 'resultsScreen') {
            // Reset all AI output areas and buttons
            aiExplanationOutputDiv.classList.add('hidden');
            aiSafeReplyOutputDiv.classList.add('hidden');
            aiThreatIntelOutputDiv.classList.add('hidden');
            aiEmailDeconstructOutputDiv.classList.add('hidden');

            aiExplanationOutputPre.textContent = '';
            aiSafeReplyOutputPre.textContent = '';
            aiThreatIntelOutputPre.textContent = '';
            aiEmailDeconstructOutputPre.textContent = '';
            
            downloadPdfBtn.classList.add('hidden');
            if(downloadAiExplanationPdfBtn) downloadAiExplanationPdfBtn.classList.add('hidden');
            if(downloadAiThreatIntelPdfBtn) downloadAiThreatIntelPdfBtn.classList.add('hidden');
            if(downloadAiEmailDeconstructPdfBtn) downloadAiEmailDeconstructPdfBtn.classList.add('hidden');
            
            urlScreenshotPlaceholderResultsDiv.classList.add('hidden');
            fileIconDisplayResults.classList.add('hidden');
        }
    }

    selectionCards.forEach(card => {
        card.addEventListener('click', () => {
            currentInputTypeGlobal = card.dataset.inputtype;
            inputTitle.textContent = card.querySelector('h3').textContent + " ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡¶®";
            Object.values(inputTypeAreas).forEach(area => area.classList.add('hidden'));
            inputTypeAreas[currentInputTypeGlobal].classList.remove('hidden');
            inputTypeAreas[currentInputTypeGlobal].classList.add('flex'); 
            
            aiSummaryBtn.classList.add('hidden'); 
            if (currentInputTypeGlobal === 'text') {
                 aiSummaryBtn.classList.toggle('hidden', mainTextInput.value.trim().length < 200);
            }
            aiSummaryNote.classList.add('hidden');
            isSummaryUsed = false;
            navigateToScreen('inputScreen');
        });
    });

    backToSelectionBtn.addEventListener('click', () => navigateToScreen('selectionScreen'));
    backToInputBtn.addEventListener('click', () => {
        mainTextInput.value = '';
        mainUrlInput.value = '';
        mainFileInput.value = ''; 
        mainFileNameDisplay.textContent = '‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø'; 
        userUploadedFileName = null; 
        aiSummaryNote.classList.add('hidden');
        isSummaryUsed = false;
        Object.values(inputTypeAreas).forEach(area => area.classList.add('hidden'));
        inputTypeAreas[currentInputTypeGlobal].classList.remove('hidden');
        inputTypeAreas[currentInputTypeGlobal].classList.add('flex');
        navigateToScreen('inputScreen'); 
    });

    mainFileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
            mainFileNameDisplay.textContent = `‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§: ${event.target.files[0].name}`;
            userUploadedFileName = event.target.files[0].name; 
        } else {
            mainFileNameDisplay.textContent = '‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø';
            userUploadedFileName = null;
        }
    });

    mainTextInput.addEventListener('input', () => {
        if (currentInputTypeGlobal === 'text') {
            aiSummaryBtn.classList.toggle('hidden', mainTextInput.value.trim().length < 200); 
            if (isSummaryUsed) { 
                isSummaryUsed = false;
                aiSummaryNote.classList.add('hidden');
            }
        }
    });
    
    function initializeMainChartResults() {
        const ctx = document.getElementById('mainRiskScoreChart').getContext('2d');
        if (mainRiskScoreChart) mainRiskScoreChart.destroy();
        mainRiskScoreChart = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: ['‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø', '‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ'],
                datasets: [{
                    data: [0, 100],
                    backgroundColor: ['var(--text-cyber-green)', 'var(--bg-dark-tertiary)'], 
                    borderColor: 'var(--bg-dark-secondary)', 
                    borderWidth: 5, hoverOffset: 8,
                }]
            },
            options: { 
                 responsive: true, maintainAspectRatio: false, cutout: '75%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                animation: { duration: 1200, easing: 'easeOutExpo' }
            }
        });
    }
    initializeMainChartResults();

    function typeWriter(element, text, speed = 30) {
        element.textContent = ''; 
        let i = 0;
        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(type, speed);
            }
        }
        type();
    }

    async function callGeminiAPI(prompt, buttonElement) {
        const geminiLoader = buttonElement.querySelector('.loader-small');
        const buttonText = buttonElement.querySelector('.btn-text');
        const originalButtonText = buttonText.textContent;

        buttonText.textContent = '‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç...';
        if(geminiLoader) geminiLoader.classList.remove('hidden');
        buttonElement.disabled = true;

        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: {message: "Unknown API error"}}));
                console.error('Gemini API Error Response:', errorData);
                throw new Error(`Gemini API ‡¶•‡ßá‡¶ï‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${errorData.error?.message || response.statusText}`);
            }
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error('Gemini API Error: Unexpected response structure', result);
                throw new Error('Gemini API ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø ‡¶¨‡¶æ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶®‡ßá‡¶á‡•§');
            }
        } catch (error) {
            console.error('Gemini API Call Failed:', error);
            showModal(`Gemini API ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ${error.message}`, 'error', 'API ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
            return `‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`;
        } finally {
            buttonText.textContent = originalButtonText;
            if(geminiLoader) geminiLoader.classList.add('hidden');
            buttonElement.disabled = false;
        }
    }

    aiSummaryBtn.addEventListener('click', async () => {
        const longText = mainTextInput.value.trim();
        if (longText.length < 200) { 
            showModal("‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ü‡¶ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶®‡¶Ø‡¶º (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß®‡ß¶‡ß¶ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®)‡•§", 'warning', '‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü');
            return;
        }
        const prompt = `‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶ü‡¶ø‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶ì ‡¶Æ‡ßÇ‡¶≤‡¶≠‡¶æ‡¶¨ ‡¶¨‡¶ú‡¶æ‡¶Ø‡¶º ‡¶∞‡ßá‡¶ñ‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶è‡¶á ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂‡¶ü‡¶ø ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶¨‡ßá‡•§ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂‡¶ü‡¶ø ‡ß®‡ß´‡ß¶ ‡¶∂‡¶¨‡ßç‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡ßÄ‡¶Æ‡¶æ‡¶¨‡¶¶‡ßç‡¶ß ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®:\n\n"${longText}"`;
        const summary = await callGeminiAPI(prompt, aiSummaryBtn);
        if (summary && !summary.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            mainTextInput.value = summary; 
            isSummaryUsed = true;
            aiSummaryNote.textContent = '‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ü‡¶ø AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂‡•§ ‡¶è‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§';
            aiSummaryNote.classList.remove('hidden');
            aiSummaryBtn.classList.add('hidden'); 
        } else if (summary && summary.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            aiSummaryNote.textContent = summary; 
            aiSummaryNote.classList.remove('hidden');
        }
    });

    aiExplanationBtn.addEventListener('click', async () => {
        const findingsText = analysisReportForGemini.findings ? 
            Object.values(analysisReportForGemini.findings).flat().map(f => f.text).join(";\n") : "‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶®‡ßá‡¶á";
        const prompt = `‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶ü‡ßÅ‡¶≤ ‡¶è‡¶ï‡¶ü‡¶ø ${currentInputTypeGlobal === 'url' ? 'URL' : currentInputTypeGlobal === 'file' ? `‡¶´‡¶æ‡¶á‡¶≤ (${userUploadedFileName || '‡¶®‡¶æ‡¶Æ‡¶¨‡¶ø‡¶π‡ßÄ‡¶®'})` : '‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ'} ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§ ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶õ‡¶ø‡¶≤: "${originalInputForGemini.substring(0,250)}..."‡•§ ‡¶ü‡ßÅ‡¶≤‡¶ü‡¶ø ‡¶è‡¶ü‡¶ø‡¶ï‡ßá ${analysisReportForGemini.score}% ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶≤‡ßã: "${findingsText}". ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶π‡¶ú ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶ï‡ßá‡¶® ‡¶è‡¶á ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡¶ü‡¶ø ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶¨‡¶æ ‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶ï‡¶∞ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶è‡¶á ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶ï‡ßÄ ‡¶ï‡ßÄ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶ø ‡¶ï‡¶Ø‡¶º‡ßá‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶ó‡ßç‡¶∞‡¶æ‡¶´‡ßá, ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßã‡¶ß‡¶ó‡¶Æ‡ßç‡¶Ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®‡•§`;
        
        aiExplanationOutputPre.textContent = ""; 
        aiExplanationOutputDiv.classList.remove('hidden');
        typeWriter(aiExplanationOutputPre, "AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...", 50); 
        const explanation = await callGeminiAPI(prompt, aiExplanationBtn);
        if (explanation && !explanation.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            typeWriter(aiExplanationOutputPre, explanation);
            if(downloadAiExplanationPdfBtn) downloadAiExplanationPdfBtn.classList.remove('hidden');
        } else {
            typeWriter(aiExplanationOutputPre, explanation || "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
             if(downloadAiExplanationPdfBtn) downloadAiExplanationPdfBtn.classList.add('hidden');
        }
    });

    aiSafeReplyBtn.addEventListener('click', async () => {
        const prompt = `‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ${currentInputTypeGlobal === 'url' ? 'URL ‡¶∏‡¶Æ‡ßç‡¶¨‡¶≤‡¶ø‡¶§ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ' : currentInputTypeGlobal === 'file' ? `‡¶´‡¶æ‡¶á‡¶≤ (${userUploadedFileName || '‡¶®‡¶æ‡¶Æ‡¶¨‡¶ø‡¶π‡ßÄ‡¶®'}) ‡¶∏‡¶Æ‡ßç‡¶¨‡¶≤‡¶ø‡¶§ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ` : '‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ'} ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡¶ø: "${originalInputForGemini.substring(0,250)}..."‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶ü‡ßÅ‡¶≤ ‡¶è‡¶ü‡¶ø‡¶ï‡ßá ‡¶Æ‡¶æ‡¶ù‡¶æ‡¶∞‡¶ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶á ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶, ‡¶®‡¶ø‡¶∞‡¶™‡ßá‡¶ï‡ßç‡¶∑ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá ‡¶¶‡¶ø‡¶®‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶§‡¶•‡ßç‡¶Ø ‡¶ú‡¶æ‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≠‡¶¶‡ßç‡¶∞‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¶‡¶ø‡¶®, ‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡ßÇ‡¶Æ‡¶ø‡¶ï‡¶æ ‡¶¨‡¶æ ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡•§`;
        
        aiSafeReplyOutputPre.textContent = ""; 
        aiSafeReplyOutputDiv.classList.remove('hidden');
        typeWriter(aiSafeReplyOutputPre, "AI ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...", 50); 
        const reply = await callGeminiAPI(prompt, aiSafeReplyBtn);
        if (reply && !reply.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            typeWriter(aiSafeReplyOutputPre, reply);
        } else {
            typeWriter(aiSafeReplyOutputPre, reply || "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
        }
    });

    // Event listener for AI Threat Intel Button
    aiThreatIntelBtn.addEventListener('click', async () => {
        const findingsText = analysisReportForGemini.findings && analysisReportForGemini.findings["URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£"] ?
                             analysisReportForGemini.findings["URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£"].map(f => f.text).join(";\n") : "‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü URL ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶®‡ßá‡¶á";
        const prompt = `‡¶è‡¶ï‡¶ü‡¶ø URL, '${originalInputForGemini}', ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£ ‡¶ü‡ßÅ‡¶≤ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ${analysisReportForGemini.score}% ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶≤‡ßã: '${findingsText}'. ‡¶è‡¶á ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá, ‡¶è‡¶á URL ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßÇ‡¶™ URL ‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ (‡ß©-‡ß™‡¶ü‡¶ø ‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá) ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶¶‡¶ø‡¶®‡•§ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£ ‡¶≠‡ßá‡¶ï‡ßç‡¶ü‡¶∞, ‡¶ï‡ßã‡¶® ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá, ‡¶è‡¶¨‡¶Ç ‡¶è‡¶á ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Ø‡¶¶‡¶ø URL‡¶ü‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§ ‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂ ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®, facebook-login.xyz), ‡¶§‡¶¨‡ßá ‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂ ‡¶ß‡¶æ‡¶∞‡¶£‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø‡¶§‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶¶‡¶ø‡¶®‡•§`;

        aiThreatIntelOutputPre.textContent = "";
        aiThreatIntelOutputDiv.classList.remove('hidden');
        typeWriter(aiThreatIntelOutputPre, "AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...", 50);
        const threatIntel = await callGeminiAPI(prompt, aiThreatIntelBtn);
        if (threatIntel && !threatIntel.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            typeWriter(aiThreatIntelOutputPre, threatIntel);
            if(downloadAiThreatIntelPdfBtn) downloadAiThreatIntelPdfBtn.classList.remove('hidden');
        } else {
            typeWriter(aiThreatIntelOutputPre, threatIntel || "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
            if(downloadAiThreatIntelPdfBtn) downloadAiThreatIntelPdfBtn.classList.add('hidden');
        }
    });

    // Event listener for AI Email Deconstruction Button
    aiEmailDeconstructBtn.addEventListener('click', async () => {
        const findingsText = analysisReportForGemini.findings ?
            Object.values(analysisReportForGemini.findings).flat().map(f => f.text).join(";\n") : "‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£ ‡¶®‡ßá‡¶á";
        const prompt = `‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡¶ü‡¶ø‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá: '${originalInputForGemini.substring(0, 500)}...'‡•§ ‡¶è‡¶ü‡¶ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡ßá ${analysisReportForGemini.score}% ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶≤‡ßã: '${findingsText}'. ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡¶ü‡¶ø‡¶ï‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶æ‡¶∑‡¶æ‡¶Ø‡¶º ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Ç‡¶∂ ‡¶¨‡¶æ ‡¶ï‡ßå‡¶∂‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø‡¶§‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶≠‡ßÇ‡¶§‡¶ø ‡¶§‡ßà‡¶∞‡¶ø, ‡¶ú‡ßá‡¶®‡ßá‡¶∞‡¶ø‡¶ï ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶∑‡¶£, ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶≤‡¶ø‡¶Ç‡¶ï, ‡§≠‡§æ‡§µ‡§®‡§æ‡§§‡•ç‡§Æ‡§ï ‡¶ö‡¶æ‡¶≤‡¶®‡¶æ, ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç‡¶è ‡¶™‡ßç‡¶∞‡¶ö‡¶≤‡¶ø‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£/‡¶¨‡¶æ‡¶®‡¶æ‡¶®‡ßá‡¶∞ ‡¶≠‡ßÅ‡¶≤) ‡¶§‡ßÅ‡¶≤‡ßá ‡¶ß‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶â‡¶™‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`;
        
        aiEmailDeconstructOutputPre.textContent = "";
        aiEmailDeconstructOutputDiv.classList.remove('hidden');
        typeWriter(aiEmailDeconstructOutputPre, "AI ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶õ‡ßá...", 50);
        const deconstruction = await callGeminiAPI(prompt, aiEmailDeconstructBtn);
        if (deconstruction && !deconstruction.startsWith("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø:")) {
            typeWriter(aiEmailDeconstructOutputPre, deconstruction);
            if(downloadAiEmailDeconstructPdfBtn) downloadAiEmailDeconstructPdfBtn.classList.remove('hidden');
        } else {
            typeWriter(aiEmailDeconstructOutputPre, deconstruction || "‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ‡•§");
            if(downloadAiEmailDeconstructPdfBtn) downloadAiEmailDeconstructPdfBtn.classList.add('hidden');
        }
    });


    copyReplyBtn.addEventListener('click', () => {
        if (aiSafeReplyOutputPre.textContent && !aiSafeReplyOutputPre.textContent.startsWith("AI ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...")) {
            const textarea = document.createElement('textarea');
            textarea.value = aiSafeReplyOutputPre.textContent;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showModal('‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success', '‡¶ï‡¶™‡¶ø ‡¶∏‡¶´‡¶≤');
            } catch (err) {
                console.error('Copy failed', err);
                showModal('‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error', '‡¶ï‡¶™‡¶ø ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•');
            }
            document.body.removeChild(textarea);
        } else {
            showModal("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡ßá‡¶á‡•§", 'warning', '‡¶ï‡ßã‡¶®‡ßã ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡ßá‡¶á');
        }
    });


    submitAnalysisBtn.addEventListener('click', async () => {
        navigateToScreen('resultsScreen');
        finalReportData.classList.add('hidden');
        resultsLoader.classList.remove('hidden');
        mainFileContentPreviewResultsDiv.classList.add('hidden');
        mainFileContentPreviewPreResults.textContent = '';
        urlScreenshotPlaceholderResultsDiv.classList.add('hidden');
        fileIconDisplayResults.classList.add('hidden');
        
        // Hide all AI feature buttons and outputs initially
        aiExplanationBtn.classList.add('hidden');
        aiSafeReplyBtn.classList.add('hidden');
        aiThreatIntelBtn.classList.add('hidden');
        aiEmailDeconstructBtn.classList.add('hidden');

        aiExplanationOutputDiv.classList.add('hidden');
        aiSafeReplyOutputDiv.classList.add('hidden');
        aiThreatIntelOutputDiv.classList.add('hidden');
        aiEmailDeconstructOutputDiv.classList.add('hidden');
        
        downloadPdfBtn.classList.add('hidden');
        if(downloadAiExplanationPdfBtn) downloadAiExplanationPdfBtn.classList.add('hidden');
        if(downloadAiThreatIntelPdfBtn) downloadAiThreatIntelPdfBtn.classList.add('hidden');
        if(downloadAiEmailDeconstructPdfBtn) downloadAiEmailDeconstructPdfBtn.classList.add('hidden');


        let analysisInput = '';

        if (currentInputTypeGlobal === 'text') {
            analysisInput = mainTextInput.value.trim();
        } else if (currentInputTypeGlobal === 'url') {
            analysisInput = mainUrlInput.value.trim();
            if (analysisInput && !analysisInput.match(/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i)) {
                showModal("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï URL ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶¶‡¶ø‡¶®‡•§", 'error', '‡¶Ö‡¶¨‡ßà‡¶ß URL');
                resultsLoader.classList.add('hidden');
                navigateToScreen('inputScreen'); 
                return;
            }
            urlScreenshotPlaceholderResultsDiv.classList.remove('hidden');
        } else if (currentInputTypeGlobal === 'file') {
            const file = mainFileInput.files[0];
            if (file) {
                fileIconDisplayResults.classList.remove('hidden');
                const iconClass = getFileIconClass(userUploadedFileName);
                fileIconDisplayResults.innerHTML = `<i class="${iconClass}"></i>`;

                if (file.type === "text/plain" || file.name.endsWith(".eml") || file.name.endsWith(".txt")) {
                    try {
                        analysisInput = await file.text();
                        mainFileContentPreviewPreResults.textContent = analysisInput.substring(0, 700) + (analysisInput.length > 700 ? "..." : "");
                        mainFileContentPreviewResultsDiv.classList.remove('hidden');
                    } catch (e) {
                        showModal("‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡¶°‡¶º‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§", 'error', '‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
                        resultsLoader.classList.add('hidden');
                        navigateToScreen('inputScreen');
                        return;
                    }
                } else {
                     analysisInput = `‡¶´‡¶æ‡¶á‡¶≤: ${userUploadedFileName}`; 
                }
            }
        }
        originalInputForGemini = analysisInput || userUploadedFileName || "N/A"; 

        if (!analysisInput && !userUploadedFileName) { 
            showModal('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶¶‡¶ø‡¶®‡•§', 'warning', '‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®');
            resultsLoader.classList.add('hidden');
            navigateToScreen('inputScreen');
            return;
        }
        
        await new Promise(resolve => setTimeout(resolve, 2500)); 

        analysisReportForGemini = performNextGenAnalysisV2(analysisInput, userUploadedFileName, currentInputTypeGlobal, isSummaryUsed);

        mainRiskScoreValue.textContent = `${analysisReportForGemini.score}%`;
        mainRiskLevelText.textContent = analysisReportForGemini.level;
        mainRiskEmoji.textContent = analysisReportForGemini.emoji;

        mainDetailedFindingsList.innerHTML = ''; 
        for (const category in analysisReportForGemini.findings) {
            if (analysisReportForGemini.findings[category].length > 0) {
                const categoryDiv = document.createElement('div');
                const categoryTitleEl = document.createElement('p'); 
                categoryTitleEl.className = 'finding-category-title';
                categoryTitleEl.textContent = category;
                categoryDiv.appendChild(categoryTitleEl);
                
                const ul = document.createElement('ul');
                ul.className = 'space-y-1.5';
                analysisReportForGemini.findings[category].forEach(findingObj => {
                    const li = document.createElement('li');
                    li.className = 'findings-list-item';
                    li.innerHTML = `${findingObj.text} <span class="finding-score-impact">(${findingObj.impact > 0 ? '+' : ''}${findingObj.impact} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</span>`;
                    ul.appendChild(li);
                });
                categoryDiv.appendChild(ul);
                mainDetailedFindingsList.appendChild(categoryDiv);
            }
        }
        if(Object.values(analysisReportForGemini.findings).every(arr => arr.length === 0) && analysisReportForGemini.score < 10) {
            const categoryDiv = document.createElement('div');
            const categoryTitleEl = document.createElement('p');
            categoryTitleEl.className = 'finding-category-title';
            categoryTitleEl.textContent = "‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£";
            categoryDiv.appendChild(categoryTitleEl);
            const li = document.createElement('li');
            li.className = 'findings-list-item';
            li.textContent = "‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßÅ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶§‡¶¨‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶¶‡¶æ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ‡ßá ‡¶∏‡¶§‡¶∞‡ßç‡¶ï ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®‡•§";
            categoryDiv.appendChild(li);
            mainDetailedFindingsList.appendChild(categoryDiv);
        }

        mainRiskScoreChart.data.datasets[0].data = [analysisReportForGemini.score, 100 - analysisReportForGemini.score];
        let chartColor = 'var(--text-cyber-green)'; 
        let textColorClass = 'text-green-400'; 
        let borderColorClass = 'border-green-500';

        if (analysisReportForGemini.score >= 75) { chartColor = '#ef4444'; textColorClass = 'text-red-500'; borderColorClass = 'border-red-500';} 
        else if (analysisReportForGemini.score >= 50) { chartColor = '#f97316'; textColorClass = 'text-orange-500'; borderColorClass = 'border-orange-500';} 
        else if (analysisReportForGemini.score >= 25) { chartColor = '#eab308'; textColorClass = 'text-yellow-500'; borderColorClass = 'border-yellow-500';} 
        
        mainRiskScoreChart.data.datasets[0].backgroundColor = [chartColor, 'var(--bg-dark-tertiary)']; 
        mainRiskScoreChart.update();

        scoreCardResultsDiv.className = `score-card-results text-center p-6 rounded-lg border-2 ${borderColorClass}`;
        mainRiskScoreValue.className = `text-5xl font-bold mt-3 ${textColorClass}`;
        mainRiskLevelText.className = `text-xl font-semibold mt-1 ${textColorClass}`;
        mainRiskEmoji.className = `text-4xl mt-2 ${textColorClass}`; 

        // Conditional display of AI feature buttons
        if (analysisReportForGemini.score >= 40) { 
            aiExplanationBtn.classList.remove('hidden');
        }
        if (analysisReportForGemini.score >= 20 && analysisReportForGemini.score < 75 && (currentInputTypeGlobal === 'text' || (currentInputTypeGlobal === 'file' && userUploadedFileName && (userUploadedFileName.endsWith('.txt') || userUploadedFileName.endsWith('.eml'))))) {
            aiSafeReplyBtn.classList.remove('hidden');
        }
        if (currentInputTypeGlobal === 'url' && analysisReportForGemini.score >= 50) {
            aiThreatIntelBtn.classList.remove('hidden');
        }
        const isTextOrReadableFile = currentInputTypeGlobal === 'text' || (currentInputTypeGlobal === 'file' && userUploadedFileName && (userUploadedFileName.endsWith('.txt') || userUploadedFileName.endsWith('.eml')));
        if (isTextOrReadableFile && analysisReportForGemini.score >= 50) {
            aiEmailDeconstructBtn.classList.remove('hidden');
        }

        downloadPdfBtn.classList.remove('hidden');

        resultsLoader.classList.add('hidden');
        finalReportData.classList.remove('hidden');
        isSummaryUsed = false; 
        aiSummaryNote.classList.add('hidden'); 
        if (currentInputTypeGlobal === 'text') { 
            aiSummaryBtn.classList.toggle('hidden', mainTextInput.value.trim().length < 200);
        }
    });

    function getFileIconClass(fileName) {
        if (!fileName) return 'fas fa-file-alt'; 
        const ext = fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase();
        switch (ext) {
            case 'txt': return 'fas fa-file-alt';
            case 'eml': return 'fas fa-envelope';
            case 'pdf': return 'fas fa-file-pdf';
            case 'doc': case 'docx': return 'fas fa-file-word';
            case 'xls': case 'xlsx': return 'fas fa-file-excel';
            case 'ppt': case 'pptx': return 'fas fa-file-powerpoint';
            case 'zip': case 'rar': case '7z': return 'fas fa-file-archive';
            case 'exe': case 'msi': return 'fas fa-cog'; 
            case 'js': case 'vbs': case 'bat': case 'sh': return 'fas fa-file-code';
            case 'jpg': case 'jpeg': case 'png': case 'gif': return 'fas fa-file-image';
            default: return 'fas fa-file';
        }
    }

    async function generatePdfUsingHtml2Canvas(generateOnlyAiContent = false, specificAiFeature = null) {
        const pdfRenderArea = document.getElementById('pdf-render-area');
        pdfRenderArea.innerHTML = ''; 

        let pdfHtml = `<h1>Banglar Shahzada ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶ó‡¶æ‡¶∞‡ßç‡¶° - `;
        if (specificAiFeature === 'explanation') pdfHtml += 'AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü';
        else if (specificAiFeature === 'threatIntel') pdfHtml += 'AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (URL)';
        else if (specificAiFeature === 'emailDeconstruct') pdfHtml += 'AI ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü';
        else pdfHtml += '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü';
        pdfHtml += `</h1>`;
        
        pdfHtml += `<p style="font-size: 9pt; color: #555;">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleString('bn-BD', { dateStyle: 'long', timeStyle: 'short'})}</p>`;
        
        let inputTypeDisplay = "";
        switch(currentInputTypeGlobal) {
            case "text": inputTypeDisplay = "‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü/‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ"; break;
            case "url": inputTypeDisplay = "URL"; break;
            case "file": inputTypeDisplay = `‡¶´‡¶æ‡¶á‡¶≤ (${userUploadedFileName || '‡¶®‡¶æ‡¶Æ‡¶¨‡¶ø‡¶π‡ßÄ‡¶®'})`; break;
        }

        if (!specificAiFeature) { // Full report content
            pdfHtml += `<h2 class="pdf-section-title">‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£‡ßá‡¶∞ ‡¶ß‡¶∞‡¶£: ${inputTypeDisplay}</h2>`;
            pdfHtml += `<h3 class="pdf-subsection-title">‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶ø‡¶§ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü:</h3>`;
            let inputToReport = originalInputForGemini;
            if (currentInputTypeGlobal === 'file' && userUploadedFileName && !(userUploadedFileName.endsWith(".txt") || userUploadedFileName.endsWith(".eml"))){
                inputToReport = `‡¶´‡¶æ‡¶á‡¶≤: ${userUploadedFileName} (‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶è‡¶á ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶®‡¶Ø‡¶º ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶è‡¶ü‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü-‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶Ø‡¶º)‡•§`;
            } else if (isSummaryUsed) {
                inputToReport = `AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂: ${originalInputForGemini}`;
            }
            pdfHtml += `<p class="input-summary" style="white-space: pre-wrap; word-wrap: break-word;">${inputToReport.substring(0,1000) + (inputToReport.length > 1000 ? "..." : "")}</p>`;

            pdfHtml += `<h2 class="pdf-section-title">‡¶∏‡¶æ‡¶Æ‡¶ó‡ßç‡¶∞‡¶ø‡¶ï ‡¶´‡¶≤‡¶æ‡¶´‡¶≤:</h2>`;
            pdfHtml += `<p><strong>‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∏‡ßç‡¶ï‡ßã‡¶∞:</strong> ${analysisReportForGemini.score}%</p>`;
            pdfHtml += `<p><strong>‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶∞ ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ:</strong> ${analysisReportForGemini.level} ${analysisReportForGemini.emoji}</p>`;

            pdfHtml += `<h2 class="pdf-section-title">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶™‡¶∞‡ßç‡¶Ø‡¶¨‡ßá‡¶ï‡ßç‡¶∑‡¶£:</h2>`;
            for (const category in analysisReportForGemini.findings) {
                if (analysisReportForGemini.findings[category].length > 0) {
                    pdfHtml += `<h3 class="pdf-subsection-title">${category}:</h3><ul>`;
                    analysisReportForGemini.findings[category].forEach(findingObj => {
                        pdfHtml += `<li class="pdf-finding-item">${findingObj.text} (${findingObj.impact > 0 ? '+' : ''}${findingObj.impact} ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü)</li>`;
                    });
                    pdfHtml += `</ul>`;
                }
            }
        }

        // Add AI Explanation
        const aiExplanationText = aiExplanationOutputPre.textContent;
        if ((!specificAiFeature || specificAiFeature === 'explanation') && !aiExplanationOutputDiv.classList.contains('hidden') && aiExplanationText && !aiExplanationText.startsWith("AI ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...")) {
            pdfHtml += `<h2 class="pdf-section-title">AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶¶‡¶§‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ñ‡ßç‡¶Ø‡¶æ:</h2>`;
            pdfHtml += `<pre>${aiExplanationText}</pre>`;
        }

        // Add AI Safe Reply (only in full report)
        if (!specificAiFeature) {
            const aiSafeReplyText = aiSafeReplyOutputPre.textContent;
            if (!aiSafeReplyOutputDiv.classList.contains('hidden') && aiSafeReplyText && !aiSafeReplyText.startsWith("AI ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...")) {
                pdfHtml += `<h2 class="pdf-section-title">AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨‡¶ø‡¶§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶â‡¶§‡ßç‡¶§‡¶∞:</h2>`;
                pdfHtml += `<pre>${aiSafeReplyText}</pre>`;
            }
        }
        
        // Add AI Threat Intel
        const aiThreatIntelText = aiThreatIntelOutputPre.textContent;
        if ((!specificAiFeature || specificAiFeature === 'threatIntel') && !aiThreatIntelOutputDiv.classList.contains('hidden') && aiThreatIntelText && !aiThreatIntelText.startsWith("AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá...")) {
            pdfHtml += `<h2 class="pdf-section-title">AI ‡¶•‡ßç‡¶∞‡ßá‡¶ü ‡¶á‡¶®‡ßç‡¶ü‡ßá‡¶≤‡¶ø‡¶ú‡ßá‡¶®‡ßç‡¶∏ (URL):</h2>`;
            pdfHtml += `<pre>${aiThreatIntelText}</pre>`;
        }

        // Add AI Email Deconstruction
        const aiEmailDeconstructText = aiEmailDeconstructOutputPre.textContent;
        if ((!specificAiFeature || specificAiFeature === 'emailDeconstruct') && !aiEmailDeconstructOutputDiv.classList.contains('hidden') && aiEmailDeconstructText && !aiEmailDeconstructText.startsWith("AI ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶õ‡ßá...")) {
            pdfHtml += `<h2 class="pdf-section-title">AI ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£:</h2>`;
            pdfHtml += `<pre>${aiEmailDeconstructText}</pre>`;
        }
        
        pdfHtml += `<p class="pdf-disclaimer">‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶¶‡ßç‡¶∞‡¶∑‡ßç‡¶ü‡¶¨‡ßç‡¶Ø: ‡¶è‡¶á ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶¨‡¶Ø‡¶º‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï ‡¶ì ‡¶§‡¶•‡ßç‡¶Ø‡¶ó‡¶§ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶§‡ßç‡¶§‡•§ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶§‡ßç‡¶§ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶¨‡¶æ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶¨‡¶ø‡¶ö‡¶æ‡¶∞‡¶¨‡ßÅ‡¶¶‡ßç‡¶ß‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑‡¶ú‡ßç‡¶û‡ßá‡¶∞ ‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂ ‡¶®‡¶ø‡¶®‡•§ ‡¶è‡¶á ‡¶ü‡ßÅ‡¶≤‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶¨‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶æ‡¶ì ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§</p>`;
        
        pdfRenderArea.innerHTML = pdfHtml;

        let pdfButtonToLoad, reportNameSuffix;
        if (specificAiFeature === 'explanation') {
            pdfButtonToLoad = downloadAiExplanationPdfBtn;
            reportNameSuffix = 'AI_Explanation';
        } else if (specificAiFeature === 'threatIntel') {
            pdfButtonToLoad = downloadAiThreatIntelPdfBtn;
            reportNameSuffix = 'AI_Threat_Intel';
        } else if (specificAiFeature === 'emailDeconstruct') {
            pdfButtonToLoad = downloadAiEmailDeconstructPdfBtn;
            reportNameSuffix = 'AI_Email_Analysis';
        } else {
            pdfButtonToLoad = downloadPdfBtn;
            reportNameSuffix = 'Full_Report';
        }

        const pdfLoader = pdfButtonToLoad.querySelector('.loader-small');
        const pdfButtonText = pdfButtonToLoad.querySelector('.btn-text');
        const originalPdfButtonText = pdfButtonText.textContent;

        pdfButtonText.textContent = '‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        if(pdfLoader) pdfLoader.classList.remove('hidden');
        pdfButtonToLoad.disabled = true;

        try {
            const canvas = await html2canvas(pdfRenderArea, {
                scale: 2, useCORS: true, logging: false,
                onclone: (doc) => { 
                    const style = doc.createElement('style');
                    style.innerHTML = ` body, #pdf-render-area, #pdf-render-area p, #pdf-render-area li, #pdf-render-area pre, #pdf-render-area h1, #pdf-render-area h2, #pdf-render-area h3, #pdf-render-area h4 { font-family: 'Noto Sans Bengali', Arial, sans-serif !important; } `;
                    doc.head.appendChild(style);
                }
            });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            
            let position = 0;
            const pageMargin = 40;
            const contentWidth = pdfWidth - (2 * pageMargin);
            const contentHeight = (imgProps.height * contentWidth) / imgProps.width; // Calculate height based on aspect ratio and available width
            const pageHeightAvailable = pdf.internal.pageSize.getHeight() - (2 * pageMargin);
            let heightLeft = contentHeight;


            pdf.addImage(imgData, 'PNG', pageMargin, pageMargin, contentWidth, contentHeight);
            heightLeft -= pageHeightAvailable;

            while (heightLeft > 0) {
                position -= pageHeightAvailable; 
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', pageMargin, position + pageMargin, contentWidth, contentHeight); 
                heightLeft -= pageHeightAvailable;
            }
            
            const reportName = `Banglar_Shahzada_${reportNameSuffix}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.pdf`;
            pdf.save(reportName);

        } catch (error) {
            console.error("Error generating PDF with html2canvas:", error);
            showModal("‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶™‡¶™-‡¶Ü‡¶™ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error', '‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø');
        } finally {
            pdfButtonText.textContent = originalPdfButtonText;
            if(pdfLoader) pdfLoader.classList.add('hidden');
            pdfButtonToLoad.disabled = false;
            pdfRenderArea.innerHTML = ''; 
        }
    }

    downloadPdfBtn.addEventListener('click', () => generatePdfUsingHtml2Canvas(false, null)); 
    if(downloadAiExplanationPdfBtn) { 
        downloadAiExplanationPdfBtn.addEventListener('click', () => generatePdfUsingHtml2Canvas(true, 'explanation')); 
    }
    if(downloadAiThreatIntelPdfBtn) {
        downloadAiThreatIntelPdfBtn.addEventListener('click', () => generatePdfUsingHtml2Canvas(true, 'threatIntel'));
    }
    if(downloadAiEmailDeconstructPdfBtn) {
        downloadAiEmailDeconstructPdfBtn.addEventListener('click', () => generatePdfUsingHtml2Canvas(true, 'emailDeconstruct'));
    }


    function performNextGenAnalysisV2(text, currentFileName, inputType, summaryWasUsed) { 
        let score = 0;
        const findings = {
            "‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)": [],
            "URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£": [],
            "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)": [],
            "‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®": [],
            "‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ‡¶∞ ‡¶ï‡ßå‡¶∂‡¶≤ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£": []
        };
        const lowerText = text ? text.toLowerCase() : ""; 
        let detectedTechniques = new Set();

        if (summaryWasUsed) {
             findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: `‡¶®‡ßã‡¶ü: ‡¶è‡¶á ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£‡¶ü‡¶ø AI ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: 0});
        }

        const keywordsDB = { 
             bn: {
                lures: ["‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞", "‡¶ú‡¶ø‡¶§‡ßÅ‡¶®", "‡¶Ü‡¶á‡¶´‡ßã‡¶®", "‡¶ó‡¶æ‡¶°‡¶º‡¶ø", "‡¶¨‡¶ø‡¶ü‡¶ï‡¶Ø‡¶º‡ßá‡¶®", "‡¶´‡ßç‡¶∞‡¶ø ‡¶ó‡¶ø‡¶´‡¶ü", "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü", "‡¶®‡¶ó‡¶¶ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü", "‡¶Ö‡¶´‡¶æ‡¶∞", "‡¶´‡ßç‡¶∞‡¶ø ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü", "‡¶¨‡¶ø‡¶®‡¶æ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶°‡¶æ‡¶ü‡¶æ", "‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó ‡¶π‡¶æ‡¶§‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ", "‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá‡¶®", "‡¶¨‡¶ø‡¶∞‡¶æ‡¶ü ‡¶õ‡¶æ‡¶°‡¶º", "‡¶è‡¶ï‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø", "‡¶ó‡ßã‡¶™‡¶® ‡¶Ö‡¶´‡¶æ‡¶∞", "‡¶â‡¶™‡¶π‡¶æ‡¶∞", "‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï", "‡¶Ö‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨", "‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡¶á ‡¶Ü‡¶Ø‡¶º", "‡¶∏‡¶π‡¶ú ‡¶ü‡¶æ‡¶ï‡¶æ", "‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶≤‡¶æ‡¶≠"],
                urgency: ["‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ", "‡¶è‡¶ñ‡¶®‡¶ø", "‡¶¶‡ßç‡¶∞‡ßÅ‡¶§", "‡¶∂‡ßá‡¶∑ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó", "‡¶Ö‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡ßá", "‡¶§‡¶æ‡¶°‡¶º‡¶æ‡¶§‡¶æ‡¶°‡¶º‡¶ø", "‡¶è‡¶ñ‡¶®‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®", "‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∏‡ßÄ‡¶Æ‡¶ø‡¶§", "‡¶¨‡¶®‡ßç‡¶ß ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá", "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá", "‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑", "‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶ï‡¶∞‡¶£‡ßÄ‡¶Ø‡¶º", "‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®", "‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ", "‡¶π‡ßÅ‡¶Æ‡¶ï‡¶ø", "‡¶Ö‡¶¨‡¶ó‡¶§ ‡¶ï‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá", "‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂"],
                credentials: ["‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®", "‡¶™‡¶ø‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶ì‡¶ü‡¶ø‡¶™‡¶ø ‡¶™‡¶æ‡¶†‡¶æ‡¶®", "OTP ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á", "‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø", "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®", "‡¶≤‡¶ó‡¶á‡¶® ‡¶§‡¶•‡ßç‡¶Ø", "‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®", "‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶®‡ßá‡¶Æ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°", "‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ì ‡¶â‡¶§‡ßç‡¶§‡¶∞", "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤", "‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø", "‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ ‡¶ï‡ßã‡¶°", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"],
                financial: ["‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶® ‡¶è‡¶ñ‡¶®‡¶á", "‡¶¨‡¶ø‡¶®‡¶ø‡¶Ø‡¶º‡ßã‡¶ó‡ßá ‡¶¶‡ßç‡¶¨‡¶ø‡¶ó‡ßÅ‡¶£ ‡¶≤‡¶æ‡¶≠", "‡¶∏‡¶π‡¶ú ‡¶∂‡¶∞‡ßç‡¶§‡ßá ‡¶ã‡¶£", "‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®", "‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶ï‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø", "‡¶¨‡¶ø‡¶≤ ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®", "‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®", "‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø", "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶™‡¶ø‡¶®", "‡¶®‡¶ó‡¶¶ ‡¶™‡¶ø‡¶®", "‡¶Ö‡¶∞‡ßç‡¶• ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®", "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏", "‡¶Ö‡¶∞‡ßç‡¶•‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß"],
                threats: ["‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶°", "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï", "‡¶Ü‡¶á‡¶®‡¶ó‡¶§ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá", "‡¶ú‡¶∞‡¶ø‡¶Æ‡¶æ‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶ï ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá", "‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶∏ ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£", "‡¶Æ‡ßç‡¶Ø‡¶æ‡¶≤‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶õ‡ßá", "‡¶§‡¶•‡ßç‡¶Ø ‡¶´‡¶æ‡¶Å‡¶∏", "‡¶π‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ", "‡¶Ö‡¶¨‡ßà‡¶ß ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡¶≤‡¶æ‡¶™"],
                impersonation: ["‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶≤‡¶õ‡¶ø", "‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ", "‡¶Ü‡¶á‡¶®‡¶∂‡ßÉ‡¶ô‡ßç‡¶ñ‡¶≤‡¶æ ‡¶¨‡¶æ‡¶π‡¶ø‡¶®‡ßÄ‡¶∞ ‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø", "‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞‡¶ø ‡¶ï‡¶∞‡ßç‡¶Æ‡¶ï‡¶∞‡ßç‡¶§‡¶æ", "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶Æ‡ßç‡¶™‡¶æ‡¶®‡¶ø‡¶∞ ‡¶∏‡¶ø‡¶á‡¶ì", "‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡¶ø‡¶Æ", "‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü", "‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü", "‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü", "‡¶®‡¶ó‡¶¶ ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü", "‡¶ï‡ßÅ‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏", "‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡ßÅ‡ßé ‡¶Ö‡¶´‡¶ø‡¶∏", "‡¶ó‡ßç‡¶Ø‡¶æ‡¶∏ ‡¶Ö‡¶´‡¶ø‡¶∏"]
            },
             en: { 
                lures: ["prize", "win big", "free iphone 15", "claim your car", "bitcoin investment opportunity", "free gift card", "exclusive offer", "free internet data", "don't miss this chance", "you have won lottery", "huge discount", "special offer for you", "secret deal", "your gift is waiting", "cashback", "limited stock", "earn without investment", "easy money", "quick profit"],
                urgency: ["urgent action required", "act immediately", "respond now", "this is your final chance", "limited time offer", "do it now", "offer expires soon", "your account will be closed", "account locked due to suspicious activity", "will be suspended", "deadline approaching", "must do today", "important notification", "security alert", "threat detected", "final notice"],
                credentials: ["enter your password", "provide your PIN", "submit OTP", "verify OTP", "confirm your details", "account verification needed", "login credentials required", "submit your information", "username and password", "security questions and answers", "update your profile information", "personal data", "verification code", "update your credentials"],
                financial: ["send money now", "double your investment", "easy loan approval", "enter card number", "bank account details", "credit card information", "pay your bill", "view invoice", "transaction ID", "bkash PIN", "payment required", "outstanding balance", "wire transfer details", "request for payment"],
                threats: ["account suspension notice", "account blocked", "legal action will be taken", "penalty fee applied", "your computer has been hacked", "virus attack detected", "malware identified", "your computer is at high risk", "data breach alert", "hacking attempt", "illegal activity detected"],
                impersonation: ["this is customer care", "bank representative calling", "member of law enforcement", "government official inquiry", "message from your CEO", "official support team", "Facebook Security Team", "Google Support", "Amazon Support", "DHL/FedEx support", "utility company", "tax office"]
            }
        };
        
        let nlpPoints = 0;
        let keywordMatchCount = 0;

        if (lowerText) { 
            for (const lang in keywordsDB) {
                for (const category in keywordsDB[lang]) {
                    keywordsDB[lang][category].forEach(keyword => {
                        if (lowerText.includes(keyword.toLowerCase())) {
                            let impact = 0;
                            let categoryNameBn = ""; let categoryNameEn = ""; let technique = null;
                            switch (category) {
                                case 'lures': impact = 18; nlpPoints += 7; categoryNameBn = "‡¶≤‡ßã‡¶≠‡¶®‡ßÄ‡¶Ø‡¶º ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡¶æ‡¶¨"; categoryNameEn = "Lure"; technique = "‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡¶´‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≤‡ßã‡¶≠ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã"; break;
                                case 'urgency': impact = 22; nlpPoints += 12; categoryNameBn = "‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ"; categoryNameEn = "Urgency"; technique = "‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ö‡¶æ‡¶™ ‡¶∏‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø"; break;
                                case 'credentials': impact = 35; nlpPoints += 18; categoryNameBn = "‡¶§‡¶•‡ßç‡¶Ø ‡¶ö‡ßÅ‡¶∞‡¶ø"; categoryNameEn = "Credential Request"; technique = "‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡¶æ ‡¶≤‡¶ó‡¶á‡¶® ‡¶§‡¶•‡ßç‡¶Ø ‡¶ö‡ßÅ‡¶∞‡¶ø‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ"; break;
                                case 'financial': impact = 28; nlpPoints += 12; categoryNameBn = "‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®"; categoryNameEn = "Financial Transaction"; technique = "‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ"; break;
                                case 'threats': impact = 30; nlpPoints += 15; categoryNameBn = "‡¶≠‡ßÄ‡¶§‡¶ø ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶®"; categoryNameEn = "Threat"; technique = "‡¶≠‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶π‡ßÅ‡¶Æ‡¶ï‡¶ø ‡¶¶‡ßá‡¶ñ‡¶ø‡¶Ø‡¶º‡ßá ‡¶ï‡¶æ‡¶ú ‡¶π‡¶æ‡¶∏‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ"; break;
                                case 'impersonation': impact = 32; nlpPoints +=15; categoryNameBn = "‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂ ‡¶ß‡¶æ‡¶∞‡¶£"; categoryNameEn = "Impersonation"; technique = "‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂ ‡¶ß‡¶æ‡¶∞‡¶£"; break;
                            }
                            score += impact;
                            findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: `"${keyword}" (${lang === 'bn' ? categoryNameBn : categoryNameEn}) ‡¶∂‡¶¨‡ßç‡¶¶‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                            if(technique) detectedTechniques.add(technique);
                            keywordMatchCount++;
                        }
                    });
                }
            }
            if (keywordMatchCount > 1) { 
                const bonus = keywordMatchCount * 2;
                score += bonus;
                findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: `‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï (${keywordMatchCount}‡¶ü‡¶ø) ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡ßÄ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶ß‡¶∞‡¶® ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§`, impact: bonus});
            }
            if (nlpPoints > 0 && findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].length > 0) { 
                 findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].unshift({text: `NLP ‡¶Æ‡¶°‡ßá‡¶≤ ${Math.min(nlpPoints, 100)}% ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡¶®‡¶æ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá (‡¶ï‡ßÄ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ì ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï)‡•§`, impact: 0});
            }


            if (lowerText.match(/!{2,}|(\burgent\b|\bimportant\b|\b‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ\b|\b‡¶è‡¶ñ‡¶®‡¶ø\b).{0,10}!+/i)) { 
                const impact = 12; score += impact;
                findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: "‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ ‡¶ú‡ßã‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶Ü‡¶¨‡ßá‡¶ó ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", impact: impact});
                detectedTechniques.add("‡¶Ü‡¶¨‡ßá‡¶ó ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶∞‡ßã‡¶ö‡¶®‡¶æ");
            }
            const words = text.split(/\s+/);
            const upperCaseWords = words.filter(w => w.length > 3 && w === w.toUpperCase() && !w.match(/^\d+$/));
            if (upperCaseWords.length > Math.max(2, Math.floor(words.length * 0.08))) { 
                const impact = 8; score += impact;
                findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: "‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶Ø‡¶º ‡¶Ö‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶¨‡¶°‡¶º ‡¶π‡¶æ‡¶§‡ßá‡¶∞ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", impact: impact});
            }
            if (lowerText.includes("kindly update your details") || lowerText.includes("your account is restrict please click") || lowerText.includes("‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü") || lowerText.includes("verify your identity by clicking") || lowerText.match(/‡¶ï‡ßç.?‡¶≤‡¶ø.?‡¶ï.? ‡¶ï.?‡¶∞.?‡¶®/i)) { 
                const impact = 10; score += impact;
                findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: "‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶¨‡¶æ‡¶ï‡ßç‡¶Ø ‡¶ó‡¶†‡¶® ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶ü‡ßá‡¶Æ‡¶™‡ßç‡¶≤‡ßá‡¶ü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§", impact: impact});
            }
            const commonMisspellings = ["acount", "pasword", "verifcation", "securety", "bkashh", "nogodd", "‡¶Ü‡¶™‡ßç‡¶®‡¶æ‡¶∞", "‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶†"];
            commonMisspellings.forEach(misspell => {
                if (lowerText.includes(misspell)) {
                    const impact = 7; score += impact;
                    findings["‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ì ‡¶™‡ßç‡¶∞‡¶æ‡¶∏‡¶ô‡ßç‡¶ó‡¶ø‡¶ï ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (NLP)"].push({text: `‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶¨‡¶æ‡¶®‡¶æ‡¶® ("${misspell}") ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá, ‡¶Ø‡¶æ ‡¶™‡ßç‡¶∞‡¶æ‡¶Ø‡¶º‡¶∂‡¶á ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶è ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡•§`, impact: impact});
                    detectedTechniques.add("‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶¨‡¶æ ‡¶¨‡¶æ‡¶®‡¶æ‡¶®");
                    return; 
                }
            });
        }

        const urls = lowerText ? [...new Set(lowerText.match(/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&//=]*)/gi) || [])] : [];
        const whitelistedExact = ['google.com', 'facebook.com', 'youtube.com', 'wikipedia.org', 'bdnews24.com', 'prothomalo.com', 'thedailystar.net', 'bbc.com', 'cnn.com', 'microsoft.com', 'apple.com', 'amazon.com', 'linkedin.com', 'twitter.com', 'instagram.com'];
        const whitelistedSuffixes = ['.gov.bd', '.edu.bd', '.mil.bd', '.gov.in', '.ac.uk', '.gov.us', '.gov.au', '.gov.ca', '.org.bd', '.gov', '.edu', '.mil']; 
        const blacklistedKeywordsInUrl = ['login-secure-now', 'verify-your-account-details', 'update-payment-info', 'free-money-claim', 'gift-card-winner', 'g00gle-support', 'faceb0ok-security', 'paypa1-resolve', 'bkaash-verify', 'nogod-update', 'support-center-live', 'weblogin-official', 'account-recovery-portal', 'appleid-confirm', 'microsoftonline-auth', 'securepaymentgateway', 'userauthentication', 'confirm-identity', 'reset-password-now'];
        const commonTypos = {'facebook.com': ['faceb0ok.com', 'facbook.com', 'faacebook.com', 'fb-login.com', 'faceboook.com', 'facebok.com'], 'google.com': ['gogle.com', 'googel.com', 'g00gle.info', 'gooogle.com', 'go<y_bin_235>gle.com'], 'paypal.com': ['payapl.com', 'paypa1.net', 'paypel.com'], 'microsoft.com': ['micr0soft.com', 'mircosoft.org', 'live-support.net', 'micosoft.com'], 'apple.com': ['appie.com', 'appleid-verify.com', 'aple.com'], 'bkash.com': ['bkaash.net', 'bkash-login.org', 'bkash.xyz', 'b-kash.info', 'bikash.com'], 'nagad.com.bd': ['nagad-verify.xyz', 'nogod.info', 'nagad-bd.net', 'nagadd.com']};
        const suspiciousTlds = ['.xyz', '.club', '.top', '.loan', '.work', '.click', '.biz', '.info', '.online', '.live', '.icu', '.gq', '.cf', '.tk', '.ml', '.buzz', '.link', '.site', '.website', '.pw', '.ws', '.cc', '.men', '.win', '.bid', '.ooo', '.stream', '.date', '.monster', '.fun', '.shop'];
        
        if (urls.length > 0) { 
            findings["URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£"].push({text: `‡¶Æ‡ßã‡¶ü ${urls.length} ‡¶ü‡¶ø URL ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ (${urls.length > 2 ? '‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ß®‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá' : ''})`, impact: 0});
            let onlineCheckPerformedCount = 0;

            urls.slice(0, 2).forEach(url_str => { 
                let urlScoreContribution = 0;
                const u_lower = url_str.toLowerCase(); 
                let isWhitelisted = false;
                let currentUrlFindingsObjects = []; 
                let urlDisplay = url_str.length > 50 ? url_str.substring(0,47) + "..." : url_str;

                try {
                    const parsedUrl = new URL(url_str); 
                    const hostname = parsedUrl.hostname.replace(/^www\./, ''); 
                    const path = parsedUrl.pathname;
                    const tld = hostname.substring(hostname.lastIndexOf('.'));

                    if (whitelistedExact.includes(hostname) || whitelistedSuffixes.some(suffix => hostname.endsWith(suffix))) {
                        currentUrlFindingsObjects.push({text: `"${hostname}" ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® (‡¶π‡ßã‡¶Ø‡¶º‡¶æ‡¶á‡¶ü‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶°)‡•§`, impact: -15}); 
                        isWhitelisted = true;
                    } else {
                        let impact = 0;
                        if (blacklistedKeywordsInUrl.some(k => u_lower.includes(k))) { impact = 40; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶è ‡¶¨‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶° ‡¶ï‡ßÄ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°/‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶® ("${blacklistedKeywordsInUrl.find(k => u_lower.includes(k))}") ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact}); }
                        for (const original in commonTypos) {
                            if (commonTypos[original].some(typo => hostname.includes(typo))) {
                                impact = 35; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `"${hostname}" ‡¶è "${original}" ‡¶è‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶æ‡¶¨‡ßç‡¶Ø ‡¶ü‡¶æ‡¶á‡¶™‡ßã‡¶∏‡ßç‡¶ï‡ßã‡¶Ø‡¶º‡¶æ‡¶ü‡¶ø‡¶Ç ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                                detectedTechniques.add("‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ (Typosquatting)"); break;
                            }
                        }
                        if (suspiciousTlds.includes(tld)) { impact = 25; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶ü‡¶™-‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® (${tld}) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡ßá‡•§`, impact: impact}); }
                        if (parsedUrl.protocol === "http:") { impact = 30; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶ü‡¶ø inseguro ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßã‡¶ï‡¶≤ (HTTP) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡ßá‡•§`, impact: impact}); }
                        if (hostname.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) { impact = 45; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø IP Address (${hostname}) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶õ‡ßá‡•§`, impact: impact}); detectedTechniques.add("‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶Ü‡¶á‡¶™‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞");}
                        if (url_str.length > 120) { impact = 15; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL (${url_str.length} ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞) ‡¶Ö‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò‡•§`, impact: impact}); }
                        if ((hostname.match(/-/g) || []).length > 3) { impact = 20; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® "${hostname}" ‡¶è ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï (‡ß©+) ‡¶π‡¶æ‡¶á‡¶´‡ßá‡¶® (-) ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact}); }
                        if (path.length > 80 && (path.includes('%') || path.includes('@') || path.includes('..'))) { 
                            impact = 18; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶™‡¶æ‡¶• (${path.length} ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞) ‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞ (%, @, ..) ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                            if(path.includes('..')) detectedTechniques.add("‡¶™‡¶æ‡¶• ‡¶ü‡ßç‡¶∞‡¶æ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶æ‡¶≤ ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ");
                        }
                        
                        const brandNames = ["google", "facebook", "microsoft", "apple", "amazon", "paypal", "bkash", "nagad", "bracbank", "citybank", "standardchartered", "daraz", "pathao", "uber", "linkedin", "twitter", "instagram", "netflix", "spotify"];
                        brandNames.forEach(brand => {
                            if ((hostname.includes(brand) && !hostname.endsWith(`.${brand}.com`) && !hostname.endsWith(`.${brand}.com.bd`) && !hostname.startsWith(`${brand}.`)) || 
                                (path.includes(`/${brand}-login`) || path.includes(`/${brand}/secure`) || path.includes(`/${brand}_support`) || hostname.includes(`${brand}-support`))) {
                                 if(!isWhitelisted && !(hostname.startsWith(brand + '.') && (whitelistedExact.includes(hostname) || whitelistedSuffixes.some(sfx => hostname.endsWith(sfx)))) ){
                                    impact = 30; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶è "${brand}" ‡¶®‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                                    detectedTechniques.add("‡¶¨‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Ö‡¶™‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞");
                                 }
                            }
                        });

                        if (!isWhitelisted && onlineCheckPerformedCount < 1 && Math.random() < 0.75) {
                            onlineCheckPerformedCount++;
                            const isPhishTankHit = Math.random() < 0.4; 
                            if (isPhishTankHit) {
                                impact = 65; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `URL ‡¶ü‡¶ø PhishTank ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§ ‡¶´‡¶ø‡¶∂‡¶ø‡¶Ç ‡¶∏‡¶æ‡¶á‡¶ü ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶° ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®)‡•§`, impact: impact});
                            } else {
                                currentUrlFindingsObjects.push({text: `URL ‡¶ü‡¶ø PhishTank ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶° ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®)‡•§`, impact: 0});
                            }
                        }
                         if (!isWhitelisted && Math.random() < 0.6) {
                            const ageIsNew = Math.random() < 0.65; 
                            if (ageIsNew) {
                                impact = 20; urlScoreContribution += impact; currentUrlFindingsObjects.push({text: `‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶®‡¶ü‡¶ø ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï‡¶ï‡¶æ‡¶≤‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶è‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø ‡¶ï‡¶Æ (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)‡•§`, impact: impact});
                            } else {
                                currentUrlFindingsObjects.push({text: `‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶®‡ßá‡¶∞ ‡¶¨‡¶Ø‡¶º‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø ‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶¨‡¶≤‡ßá ‡¶Æ‡¶®‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)‡•§`, impact: -5}); 
                            }
                        }
                    }
                } catch (e) { 
                    let impact = 5; urlScoreContribution += impact;
                    currentUrlFindingsObjects.push({text: `URL "${urlDisplay}" ‡¶ü‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                }
                
                if (currentUrlFindingsObjects.length > 0) {
                    findings["URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£"].push({text: `URL "${urlDisplay}":`, impact: 0}); 
                    currentUrlFindingsObjects.forEach(f => findings["URL ‡¶ì ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£"].push(f)); 
                }
                score += urlScoreContribution;
            });
        }

        if (inputType === 'text' && lowerText && (lowerText.includes("from:") || lowerText.includes("subject:") || lowerText.includes("received:"))) {
            const fromMatch = text.match(/^(?:from|‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï):\s*.*<([^>]+)>/im) || text.match(/^(?:from|‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï):\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/im);
            const replyToMatch = text.match(/^(?:reply-to|‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶®):\s*.*<([^>]+)>/im) || text.match(/^(?:reply-to|‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶®):\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/im);
            const subjectMatch = text.match(/^(?:subject|‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º):\s*(.*)/im);
            const receivedHeaderMatch = text.match(/^received:\s*from\s*([\w.-]+)\s*/im);

            if (fromMatch && subjectMatch) { 
                const fromAddress = (fromMatch[1] || fromMatch[2]).trim();
                let fromDomain = "";
                try { fromDomain = new URL("http://" + fromAddress.split('@')[1]).hostname.replace(/^www\./, ''); } catch(e){}

                if (replyToMatch) {
                    const replyToAddress = (replyToMatch[1] || replyToMatch[2]).trim();
                    if (fromAddress.toLowerCase() !== replyToAddress.toLowerCase()) {
                        const impact = 25; score += impact;
                        findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (${fromAddress}) ‡¶è‡¶¨‡¶Ç Reply-To ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ (${replyToAddress}) ‡¶≠‡¶ø‡¶®‡ßç‡¶®‡•§ ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ‡¶∞ ‡¶ï‡ßå‡¶∂‡¶≤ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§`, impact: impact});
                        detectedTechniques.add("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® (Reply-To Mismatch)");
                    }
                }
                if (fromDomain && (blacklistedKeywordsInUrl.some(k => fromDomain.includes(k)) || suspiciousTlds.some(tld => fromDomain.endsWith(tld)) || Object.values(commonTypos).flat().some(typo => fromDomain.includes(typo)) )) {
                     const impact = 30; score += impact;
                     findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® (${fromDomain}) ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï‡•§`, impact: impact});
                } else if (fromDomain && !whitelistedExact.includes(fromDomain) && !whitelistedSuffixes.some(s => fromDomain.endsWith(s)) && Math.random() < 0.25) { 
                     const impact = 18; score += impact;
                     findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® (${fromDomain}) ‡¶Ö‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`, impact: impact});
                }
                if (receivedHeaderMatch) {
                    const receivedDomain = receivedHeaderMatch[1].toLowerCase();
                    if (fromDomain && !receivedDomain.includes(fromDomain.split('.').slice(-2).join('.'))) { 
                        const impact = 20; score += impact;
                        findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá‡¶∞ "Received" ‡¶π‡ßá‡¶°‡¶æ‡¶∞ (${receivedDomain}) ‡¶è‡¶¨‡¶Ç "From" ‡¶°‡ßã‡¶Æ‡ßá‡¶á‡¶® (${fromDomain}) ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡¶∏‡¶æ‡¶Æ‡¶û‡ßç‡¶ú‡¶∏‡ßç‡¶Ø ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`, impact: impact});
                        detectedTechniques.add("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶™‡¶æ‡¶• ‡¶Ö‡¶∏‡¶æ‡¶Æ‡¶û‡ßç‡¶ú‡¶∏‡ßç‡¶Ø (Received Header Mismatch)");
                    }
                }

                if (Math.random() < 0.4) { 
                    const failedChecks = ["SPF", "DKIM", "DMARC"].filter(() => Math.random() < 0.5).join('/');
                    if(failedChecks){
                        const impact = 20; score += impact;
                        findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá‡¶∞ ${failedChecks} ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§ ‡¶¨‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£ (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)‡•§ ‡¶è‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶ö‡¶Ø‡¶º ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡•§`, impact: impact});
                        detectedTechniques.add("‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶Æ‡¶æ‡¶£‡ßÄ‡¶ï‡¶∞‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡¶§‡¶æ (SPF/DKIM/DMARC)");
                    }
                } else if (findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].length === 0) { 
                     findings["‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø)"].push({text: `‡¶á‡¶Æ‡ßá‡¶á‡¶≤‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° (SPF/DKIM) ‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶¨‡¶≤‡ßá ‡¶Æ‡¶®‡ßá ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)‡•§`, impact: 0});
                }
            }
        }

        if (currentFileName && inputType === 'file') { 
            const ext = currentFileName.substring(currentFileName.lastIndexOf('.')).toLowerCase();
            const highlySuspiciousExt = ['.exe', '.vbs', '.js', '.bat', '.cmd', '.scr', '.msi', '.jar', '.pyc', '.dll', '.ps1', '.sh', '.com', '.pif', '.hta', '.lnk'];
            const moderatelySuspiciousExt = ['.docm', '.xlsm', '.pptm', '.iso', '.img', '.zip', '.rar', '.7z', '.ace', '.dmg', '.wsf', '.cpl', '.html', '.htm']; 
            const disguisedExtPatterns = [/\.pdf\.exe$/, /\.docx?\.js$/, /\.jpg\.bat$/, /\.txt\.vbs$/, /\.mp3\.exe$/, /\.png\.scr$/, /\.gif\.exe$/, /\.html\.js$/, /\.xls\.exe$/];
            let fileFindingMade = false;

            if (highlySuspiciousExt.includes(ext)) {
                const impact = 70; score += impact; 
                findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶Æ‡¶æ‡¶∞‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø: ‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü‡ßá‡¶¨‡¶≤/‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü (${ext})‡•§ ‡¶è‡¶ü‡¶ø ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶¨‡¶ø‡¶™‡¶ú‡ßç‡¶ú‡¶®‡¶ï‡•§ (ClamAV ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)`, impact: impact});
                detectedTechniques.add("‡¶ï‡ßç‡¶∑‡¶§‡¶ø‡¶ï‡¶∞ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü‡ßá‡¶¨‡¶≤/‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü)");
                fileFindingMade = true;
            } else if (moderatelySuspiciousExt.includes(ext)) {
                const impact = 40; score += impact; 
                 findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" (${ext}) ‡¶™‡ßç‡¶∞‡¶æ‡¶Ø‡¶º‡¶∂‡¶á ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶≤‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶§‡¶∞‡¶£‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡•§ ‡¶¨‡¶ø‡¶∑‡¶Ø‡¶º‡¶¨‡¶∏‡ßç‡¶§‡ßÅ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶ñ‡ßÅ‡¶≤‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§ (ClamAV ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)`, impact: impact});
                 detectedTechniques.add("‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠/‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∞‡ßã-‡¶∏‡¶Æ‡ßç‡¶¨‡¶≤‡¶ø‡¶§/‡¶°‡¶ø‡¶∏‡ßç‡¶ï ‡¶á‡¶Æ‡ßá‡¶ú)");
                 fileFindingMade = true;
            }
            
            if (!fileFindingMade) {
                disguisedExtPatterns.forEach(pattern => {
                    if (currentFileName.toLowerCase().match(pattern)) {
                        const impact = 80; score += impact; 
                        findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶Æ‡¶æ‡¶∞‡¶æ‡¶§‡ßç‡¶Æ‡¶ï ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø: ‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂‡ßÄ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ø‡¶æ ‡¶§‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§‡¶ø ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨‡¶§ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶≤‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞‡•§ (ClamAV ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)`, impact: impact});
                        detectedTechniques.add("‡¶õ‡¶¶‡ßç‡¶Æ‡¶¨‡ßá‡¶∂‡ßÄ (Disguised) ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü");
                        fileFindingMade = true;
                    }
                });
            }
            
            if (['.doc', '.docx', '.xls', '.xlsx', '.pdf', '.zip', '.rar'].includes(ext) && Math.random() < 0.3) {
                const impact = 30; score += impact;
                findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶° ‡¶∏‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶¨‡¶ï‡ßç‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£‡ßá ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶Ü‡¶ö‡¶∞‡¶£ ‡¶¶‡ßá‡¶ñ‡¶ø‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶Ø‡ßá‡¶Æ‡¶®, ‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ)‡•§`, impact: impact});
                detectedTechniques.add("‡¶∏‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï ‡¶Ü‡¶ö‡¶∞‡¶£ (‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶ü‡ßá‡¶°)");
                fileFindingMade = true;
            }

            if (!fileFindingMade && (ext === ".txt" || ext === ".eml")) {
                 findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" (${ext}) ‡¶è‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá (‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶á‡¶®‡¶™‡ßÅ‡¶ü‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡ßá)‡•§`, impact: 0});
            } else if (!fileFindingMade) {
                 findings["‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ö‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶®"].push({text: `‡¶´‡¶æ‡¶á‡¶≤ "${currentFileName}" (${ext}) ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßá‡¶®‡¶∂‡¶®-‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§`, impact: 0});
            }
        }
        
        if (detectedTechniques.size > 0) {
            findings["‡¶™‡ßç‡¶∞‡¶§‡¶æ‡¶∞‡¶£‡¶æ‡¶∞ ‡¶ï‡ßå‡¶∂‡¶≤ ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£"] = Array.from(detectedTechniques).map(tech => ({text: tech, impact: 0}));
        }

        score = Math.min(Math.max(Math.round(score), 0), 100);

        let level = "‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶"; let emoji = "‚úÖ";
        if (score >= 75) { level = "‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£"; emoji = "üö®"; }
        else if (score >= 50) { level = "‡¶â‡¶ö‡ßç‡¶ö ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø"; emoji = "‚ò£Ô∏è"; }
        else if (score >= 25) { level = "‡¶∏‡¶®‡ßç‡¶¶‡ßá‡¶π‡¶ú‡¶®‡¶ï"; emoji = "‚ö†Ô∏è"; }
        else if (score >= 10) { level = "‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ü‡¶æ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï ‡¶•‡¶æ‡¶ï‡ßÅ‡¶®"; emoji = "ü§î"; }
        
        return { score, level, emoji, findings };
    }
    navigateToScreen('selectionScreen');
</script>
</body>
</html>
